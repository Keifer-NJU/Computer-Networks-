## vmware 虚拟机三种网络模式--“桥接、NAT、仅主机” 原理与区别



打开vmware虚拟机，我们可以在选项栏的“编辑”下的“虚拟网络编辑器”中看到VMnet0（桥接模式）、VMnet1（仅主机模式）、VMnet8（NAT模式），那么这些都是有什么作用呢？其实，我们现在看到的VMnet0表示的是用于桥接模式下的虚拟交换机；VMnet1表示的是用于仅主机模式下的虚拟交换机；VMnet8表示的是用于NAT模式下的虚拟交换机。

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-66d5be9747b4a11f4a895ab3b25ca0b1_720w.jpg)

同时，在主机上对应的有VMware Network Adapter VMnet1和VMware Network Adapter VMnet8两块虚拟网卡，它们分别作用于仅主机模式与NAT模式下。在“网络连接”中我们可以看到这两块虚拟网卡，如果将这两块卸载了，可以在vmware的“编辑”下的“虚拟网络编辑器”中点击“还原默认设置”，可重新将虚拟网卡还原。

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-520f7e74aaf946acf55d0835ccac6de2_720w.jpg)



小伙伴看到这里，肯定有疑问，为什么在真机上没有VMware Network Adapter VMnet0虚拟网卡呢？那么接下来，我们就一起来看一下这是为什么。

### 1、桥接模式

什么是桥接模式？桥接模式就是将主机网卡与虚拟机虚拟的网卡利用虚拟网桥进行通信。**在桥接的作用下，类似于把物理主机虚拟为一个交换机，所有桥接设置的虚拟机连接到这个交换机的一个接口上，物理主机也同样插在这个交换机当中（通俗解释见下面）**，所以所有桥接下的网卡与网卡都是交换模式的，相互可以访问而不干扰。在桥接模式下，虚拟机ip地址需要与主机在同一个网段，如果需要联网，则网关与DNS需要与主机网卡一致。其网络结构如下图所示：

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-0e29e8f13495c269f3fdc723aa2255c2_720w.jpg)

**通俗解释：**虚拟机相当于局域网中的一台独立机器，和主机处于同一个网段，公用同一 个网关，示意图如下

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-67081c7507a23fde741ad4b16ea65dee_720w.jpg)

桥接模式的特点是它的虚拟网卡作为实际的物理网卡与外界通信，与它所在的物理主机上的物理网卡没有什么联系，在别人看来，VMnet0这块网卡是实际存在的，它通过路由直接与外界通信。可以这样理解当你选择了桥接模式你的虚拟机已被外界当做实际存在的机器。

**通信联网情况**

| 情景                                     | 能否通信                                 | 原理                                                         |
| ---------------------------------------- | ---------------------------------------- | ------------------------------------------------------------ |
| 虚拟机与主机                             | 能                                       | 类似同一局域网的两台机子                                     |
| 同一路由（同一局域网）下其它主机与虚拟机 | 能                                       | 虚拟机相当于局域网中一台独立机子，和其它机子通信跟和主机通信的关系一致 |
| 虚拟机访问外网                           | 能，但是需要自己联网，不能与主机共用网络 | 虚拟机相当于局域网中一台独立机子，需自己联网                 |

### 2、NAT模式

如果你的网络ip资源紧缺，但是你又希望你的虚拟机能够联网，这时候NAT模式是最好的选择。NAT模式借助**虚拟NAT设备和虚拟DHCP服务器**，使得虚拟机可以联网。其网络结构如下图所示：

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-871f30dcb6c7880405c0d8ff3d90f06d_720w.jpg)

在NAT模式中，主机网卡直接与虚拟NAT设备相连，然后虚拟NAT设备与虚拟DHCP服务器一起连接在虚拟交换机VMnet8上，这样就实现了虚拟机联网。那么我们会觉得很奇怪，为什么需要虚拟网卡VMware Network Adapter VMnet8呢？原来我们的VMware Network Adapter VMnet8虚拟网卡主要是为了实现主机与虚拟机之间的通信。

**通俗解释：**

如果你不在局域网内，只有一个IP，那么NAT模式正适合你。当然如果你在局域网内，NAT模式也未尝不可，不过使用NAT模式后，**主机就变成了双网卡（<font color="red">双网卡代表基本不在同一网段，就是同一主机或者同一路由的两个网卡理论上不允许在同一网段</font>）：本身的 网卡连接Internet或连接拨号的路由器，另一个虚拟网卡VMnet8连接由虚拟机组成的一个虚拟网络。从外部网络来看，无法直接访问这个虚拟网络。虚拟网络则通过本机上的 NAT虚拟服务器进行转发访问Internet。**示意图如下（跟上面本质是一样的，就是Vmnet8虚拟交换机理解为第二张网卡）：

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-2bfaf54175a38a28d6532a2929ece65f_720w.jpg)

NAT模式是让虚拟机实现访问Internet最快的方式，几乎不用任何配置，只要主机能上网，那么虚拟机也就肯定能上网。

**虚拟NAT设备**

NAT模式下有个重要概念，帮助虚拟机上网的关键，也是理解NAT模式的重点，下面详细介绍一下

NAT 设备属于 DNS 代理，可将 DNS 请求从虚拟机转发到主机系统已经识别的 DNS 服务器。响应信息会返回 NAT 设备，然后被转发到虚拟机中。如果虚拟机们是从虚拟 DHCP 服务器获得配置信息，NAT 网络上的虚拟机将使用 NAT 设备作为 DNS 服务器。专用 NAT 网络中的虚拟机无法通过 DNS 访问。要让 NAT 网络上运行的虚拟机按照 DNS 名称相互访问，您必须设置一个连接到 NAT 网络的专用 DNS 服务器并将虚拟机配置为使用 DNS 服务器**（这一块涉及虚拟机的DNS相关原理，作者也暂时没有深入探究，大家有兴趣可以单独去学习学习）**

虚拟NAT 设备连接到 VMnet8 虚拟交换机。连接到 NAT 网络的虚拟机也会使用 VMnet8 虚拟交换机。

NAT 设备会等待 VMnet8 虚拟网络中的虚拟机发出的数据包。**当数据包抵达时，NAT 设备会将虚拟机地址转换为主机系统的地址，然后再将数据包转发到外部网络。**

当数据从专用网络虚拟机的外部网络送达时，NAT 设备会接收数据，将网络地址替换为虚拟机地址，然后将数据转发到虚拟网络的虚拟机中。这种转换会自动进行，只需对客户机操作系统和主机系统进行少量配置即可。

**通信联网情况**

| 情景                                     | 能否通信                            | 原理                                                         |
| ---------------------------------------- | ----------------------------------- | ------------------------------------------------------------ |
| 虚拟机与主机                             | 能                                  | 虽然是不同网段，但是有虚拟网卡VMware Network Adapter VMnet8，  帮助两者通信，类似于一个路由器 |
| 同一路由（同一局域网）下其它主机与虚拟机 | 能，但是需要自己配置NAT设备端口转发 | 不在同一网段，且没有类似虚拟网卡VMware Network Adapter VMnet8的东西建立通信。<br />从 NAT 网络外部向 NAT 网络虚拟机发起的网络连接则不是透明的。当外部网络中的计算机尝试发起对 NAT 网络虚拟机的连接时，它将无法访问该虚拟机，因为 NAT 设备并不会转发请求。您可以在 NAT 设备上手动配置端口转发，以便指向特定端口的网络流量仍然能被自动转发到 NAT 网络虚拟机。 |
| 虚拟机访问外网                           | 能，与主机公用网络                  | 在外部网络中，位于 NAT 网络的虚拟机会显示为主机系统，因为其网络流量使用了主机系统的 IP 地址。虚拟机可以使用 TCP/IP 协议，面向任何可从主机系统访问的计算机收发数据。<br />在开始通信前，NAT 设备在专用 NAT 网络的虚拟机地址和外部网络的主机网络地址之间建立映射。当虚拟机向其他网络资源发起网络连接时，系统会自动创建该映射。**此操作对于 NAT 网络虚拟机的用户来说是透明的。<br />从 NAT 网络外部向 NAT 网络虚拟机发起的网络连接则不是透明的。**当外部网络中的计算机尝试发起对 NAT 网络虚拟机的连接时，它将无法访问该虚拟机，因为 NAT 设备并不会转发请求。您可以在 NAT 设备上手动配置端口转发，以便指向特定端口的网络流量仍然能被自动转发到 NAT 网络虚拟机。 |

### 3、Host-Only(仅主机模式)

Host-Only模式其实就是NAT模式去除了虚拟NAT设备，然后使用VMware Network Adapter VMnet1虚拟网卡连接VMnet1虚拟交换机来与虚拟机通信的，Host-Only模式将虚拟机与外网隔开，使得虚拟机成为一个独立的系统，只与主机相互通讯。其网络结构如下图所示：

![image-20210316111341088](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\image-20210316111341088.png)通过上图，我们可以发现，如果要使得虚拟机能联网，我们可以将主机网卡共享给VMware Network Adapter VMnet1网卡，从而达到虚拟机联网的目的，**即上图主机网卡和VMware Network Adapter VMnet1之间的那条红线**。（具体操作见：https://zhuanlan.zhihu.com/p/56658358）

**通俗解释：**Host-only模式和NAT一样，也相当于主机双网卡，网络拓扑和NAT也是一样，只是主机不提供NAT功能了，所以虚拟网络只能和主机访问，不能访问Internet。如果需要一个完 全隔离的网络环境，则Host-only最合适不过。

![img](D:\OneDriver_edu\OneDrive - smail.nju.edu.cn\Java\MarkDown_AE86\计算机网络\image\v2-33400f4018046f7cc73581aeae84c447_720w.jpg)

**通信联网情况**

| 情景                                     | 能否通信                   | 原理                                                         |
| ---------------------------------------- | -------------------------- | ------------------------------------------------------------ |
| 虚拟机与主机                             | 能                         | 虽然是不同网段，但是有虚拟网卡VMware Network Adapter VMnet1，  帮助两者通信，类似于一个路由器 |
| 同一路由（同一局域网）下其它主机与虚拟机 | 不能                       | 不在同一网段，且没有类似虚拟网卡VMware Network Adapter VMnet8的东西建立通信。<br />且无NAT设备转换 |
| 虚拟机访问外网                           | 能，但是得自己配置网卡共享 | 如果要使得虚拟机能联网，我们可以将主机网卡共享给VMware Network Adapter VMnet1网卡，从而达到虚拟机联网的目的，**即上图主机网卡和VMware Network Adapter VMnet1之间的那条红线**。（具体操作见：https://zhuanlan.zhihu.com/p/56658358） |



### 4、结语

​	本文主要记录VMware三种网络模式的原理及结构（图片来自网络），不涉及具体的实战操作，实战操作网上可以搜索，懂了原理后，基本一看教程就懂了。这里也推荐一篇。

- 实战推荐：https://zhuanlan.zhihu.com/p/56658358





#### **参考**

- [vmware 虚拟机三种网络模式—“桥接、NAT 、仅主机”区别？](https://zhuanlan.zhihu.com/p/56658358)
- [了解NAT设备](https://docs.vmware.com/cn/VMware-Workstation-Pro/12.0/com.vmware.ws.using.doc/GUID-A1D6B380-680B-46A8-A70D-572562EB935E.html)
- [虚拟机三种网络模式](https://zhuanlan.zhihu.com/p/87447426)
- [浅谈vmware网络连接方式](https://zhuanlan.zhihu.com/p/133762919)
- [详细讲解VMware Workstation在你计算机上虚拟出来的交换机--韩老师的《计算机网络原理》](https://www.bilibili.com/video/BV1jK4y1e7BE?p=53)

